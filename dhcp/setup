#!/bin/bash
# dhcp/setup - Install and configure ISC DHCP Server
#
# This script installs ISC DHCP Server and deploys your configuration.
# Automatically detects and deploys files referenced by 'include' statements.
# Targeted for Ubuntu/Debian systems.
#
# Usage: yamc -h hostname -u root dhcp
# Resources required: dhcpd.conf (plus any files it includes)

set -e  # Exit on any error

echo "===== Installing ISC DHCP Server ====="

# Check if we're running as root
if [ "$(id -u)" -ne 0 ]; then
  echo "ERROR: This script must be run as root"
  exit 1
fi

# Validate resources directory
if [ -z "$RES_DIR" ] || [ ! -d "$RES_DIR" ]; then
  echo "ERROR: No resources directory specified or directory not found."
  echo "Usage: yamc -h hostname -u root dhcp"
  exit 1
fi

echo "Using resources from: $RES_DIR"

# Ubuntu/Debian paths
DHCP_CONF_DIR="/etc/dhcp"
DHCP_SERVICE="isc-dhcp-server"
DHCP_DEFAULTS="/etc/default/isc-dhcp-server"

# Check for required files
if [ ! -f "$RES_DIR/dhcpd.conf" ]; then
  echo "ERROR: dhcpd.conf not found in resources directory"
  exit 1
fi

# Function to find local file for an include path
find_local_include() {
  local remote_path="$1"
  local basename=$(basename "$remote_path")
  
  if [ -f "$RES_DIR/$basename" ]; then
    echo "$basename"
    return 0
  fi
  
  local short_name="${basename#dhcpd-}"
  if [ -f "$RES_DIR/$short_name" ]; then
    echo "$short_name"
    return 0
  fi
  
  return 1
}

# Function to deploy include files from a config
deploy_includes() {
  local config_file="$1"
  
  local includes=$(grep -E '^\s*include\s+"[^"]+"' "$config_file" 2>/dev/null | \
                   sed 's/.*include\s*"\([^"]*\)".*/\1/' || true)
  
  if [ -z "$includes" ]; then
    return 0
  fi
  
  echo "Deploying include files..."
  
  for remote_path in $includes; do
    local local_file=$(find_local_include "$remote_path")
    
    if [ -z "$local_file" ]; then
      echo "ERROR: Cannot find local file for include: $remote_path"
      echo "  Looked for: $(basename "$remote_path") or $(basename "$remote_path" | sed 's/^dhcpd-//')"
      echo "  In directory: $RES_DIR"
      exit 1
    fi
    
    echo "  $local_file -> $remote_path"
    cp "$RES_DIR/$local_file" "$remote_path"
    chown root:root "$remote_path"
    chmod 644 "$remote_path"
  done
}

# Install DHCP server if not present
if ! dpkg -l isc-dhcp-server >/dev/null 2>&1; then
  echo "Installing ISC DHCP Server..."
  apt-get update -q
  apt-get install -y isc-dhcp-server
fi

echo "ISC DHCP Server installed"

# Stop service before configuration
echo "Stopping $DHCP_SERVICE service..."
systemctl stop "$DHCP_SERVICE" 2>/dev/null || true

# Create config directory if needed
mkdir -p "$DHCP_CONF_DIR"

# Backup existing configuration
if [ -f "$DHCP_CONF_DIR/dhcpd.conf" ] && [ ! -f "$DHCP_CONF_DIR/dhcpd.conf.orig" ]; then
  echo "Backing up original dhcpd.conf..."
  cp "$DHCP_CONF_DIR/dhcpd.conf" "$DHCP_CONF_DIR/dhcpd.conf.orig"
fi

# Deploy main config
echo "Deploying dhcpd.conf..."
cp "$RES_DIR/dhcpd.conf" "$DHCP_CONF_DIR/dhcpd.conf"
chown root:root "$DHCP_CONF_DIR/dhcpd.conf"
chmod 644 "$DHCP_CONF_DIR/dhcpd.conf"

# Auto-detect and deploy include files
deploy_includes "$DHCP_CONF_DIR/dhcpd.conf"

# Check if interface is configured
if [ -f "$DHCP_DEFAULTS" ]; then
  if grep -q '^INTERFACESv4=""' "$DHCP_DEFAULTS" || ! grep -q '^INTERFACESv4=' "$DHCP_DEFAULTS"; then
    echo ""
    echo "WARNING: No network interface configured for DHCP server."
    echo "You may need to edit $DHCP_DEFAULTS and set INTERFACESv4=\"eth0\""
    echo ""
    
    MAIN_IF=$(ip route | grep default | awk '{print $5}' | head -1)
    if [ -n "$MAIN_IF" ]; then
      echo "Detected main interface: $MAIN_IF"
      read -p "Configure DHCP to listen on $MAIN_IF? (y/N) " confirm
      if [ "$confirm" = "y" ] || [ "$confirm" = "Y" ]; then
        sed -i "s/^INTERFACESv4=.*/INTERFACESv4=\"$MAIN_IF\"/" "$DHCP_DEFAULTS"
        echo "Set INTERFACESv4=\"$MAIN_IF\""
      fi
    fi
  fi
fi

# Verify configuration syntax
echo "Verifying DHCP configuration..."
if dhcpd -t -cf "$DHCP_CONF_DIR/dhcpd.conf" 2>&1; then
  echo "Configuration syntax OK"
else
  echo "ERROR: Configuration syntax check failed"
  exit 1
fi

# Enable and start service
echo "Enabling $DHCP_SERVICE service..."
systemctl enable "$DHCP_SERVICE"

echo "Starting $DHCP_SERVICE service..."
systemctl start "$DHCP_SERVICE"

# Verify service is running
sleep 2
if systemctl is-active --quiet "$DHCP_SERVICE"; then
  echo "$DHCP_SERVICE service is running"
else
  echo "ERROR: $DHCP_SERVICE service failed to start"
  echo "Check: journalctl -u $DHCP_SERVICE"
  systemctl status "$DHCP_SERVICE"
  exit 1
fi

echo ""
echo "===== ISC DHCP Server Installation Complete ====="
exit 0
