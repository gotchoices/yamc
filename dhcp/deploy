#!/bin/bash
# dhcp/deploy - Deploy DHCP configuration without editing
#
# This script deploys the current configuration files to the server.
# Automatically detects and deploys files referenced by 'include' statements.
# Targeted for Ubuntu/Debian systems.
#
# Usage: yamc -h hostname -u root dhcp deploy

set -e  # Exit on any error

echo "===== Deploying DHCP Configuration ====="

# Check if we're running as root
if [ "$(id -u)" -ne 0 ]; then
  echo "ERROR: This script must be run as root"
  exit 1
fi

# Validate resources directory
if [ -z "$RES_DIR" ] || [ ! -d "$RES_DIR" ]; then
  echo "ERROR: Resources directory not available."
  exit 1
fi

echo "Deploying from: $RES_DIR"

# Ubuntu/Debian paths
DHCP_CONF_DIR="/etc/dhcp"
DHCP_SERVICE="isc-dhcp-server"

# Check for required files
if [ ! -f "$RES_DIR/dhcpd.conf" ]; then
  echo "ERROR: dhcpd.conf not found in resources directory"
  exit 1
fi

# Function to find local file for an include path
find_local_include() {
  local remote_path="$1"
  local basename=$(basename "$remote_path")
  
  if [ -f "$RES_DIR/$basename" ]; then
    echo "$basename"
    return 0
  fi
  
  local short_name="${basename#dhcpd-}"
  if [ -f "$RES_DIR/$short_name" ]; then
    echo "$short_name"
    return 0
  fi
  
  return 1
}

# Track if anything changed
CHANGED=0

# Check and deploy main config
echo "Checking for changes..."
if [ -f "$DHCP_CONF_DIR/dhcpd.conf" ] && cmp -s "$RES_DIR/dhcpd.conf" "$DHCP_CONF_DIR/dhcpd.conf"; then
  echo "  Unchanged: dhcpd.conf"
else
  echo "  Updated: dhcpd.conf"
  cp "$RES_DIR/dhcpd.conf" "$DHCP_CONF_DIR/dhcpd.conf"
  chown root:root "$DHCP_CONF_DIR/dhcpd.conf"
  chmod 644 "$DHCP_CONF_DIR/dhcpd.conf"
  CHANGED=1
fi

# Deploy include files
includes=$(grep -E '^\s*include\s+"[^"]+"' "$RES_DIR/dhcpd.conf" 2>/dev/null | \
           sed 's/.*include\s*"\([^"]*\)".*/\1/' || true)

for remote_path in $includes; do
  local_file=$(find_local_include "$remote_path")
  
  if [ -z "$local_file" ]; then
    echo "ERROR: Cannot find local file for include: $remote_path"
    echo "  In directory: $RES_DIR"
    exit 1
  fi
  
  if [ -f "$remote_path" ] && cmp -s "$RES_DIR/$local_file" "$remote_path"; then
    echo "  Unchanged: $local_file"
  else
    echo "  Updated: $local_file -> $remote_path"
    cp "$RES_DIR/$local_file" "$remote_path"
    chown root:root "$remote_path"
    chmod 644 "$remote_path"
    CHANGED=1
  fi
done

# If nothing changed, exit early
if [ "$CHANGED" -eq 0 ]; then
  echo ""
  echo "No files changed. Service restart not needed."
  echo "===== DHCP Configuration Unchanged ====="
  exit 0
fi

# Verify configuration before restarting
echo ""
echo "Verifying configuration..."
if ! dhcpd -t -cf "$DHCP_CONF_DIR/dhcpd.conf" 2>&1; then
  echo "ERROR: Configuration syntax check failed!"
  echo "The service has NOT been restarted."
  exit 1
fi
echo "Configuration syntax OK"

# Restart service
echo ""
echo "Restarting $DHCP_SERVICE service..."
systemctl restart "$DHCP_SERVICE"

# Verify service is running
sleep 2
if systemctl is-active --quiet "$DHCP_SERVICE"; then
  echo "$DHCP_SERVICE service restarted successfully"
else
  echo "ERROR: $DHCP_SERVICE service failed to restart"
  echo "Check: journalctl -u $DHCP_SERVICE"
  systemctl status "$DHCP_SERVICE"
  exit 1
fi

echo ""
echo "===== DHCP Configuration Deployed ====="
exit 0
