#!/bin/bash
# cups/setup - Install CUPS and configure printers on Ubuntu
#
# Usage: yamc -h hostname -u root cups
#
# Structure in yamc.local/cups/:
#   printers.conf     - Printer definitions
#   ppd/              - Custom PPD files
#   filters/          - Custom filter scripts

set -e

echo "===== Configuring CUPS Printing ====="

# Install CUPS and common drivers
echo "Installing CUPS packages..."
apt-get update -qq
apt-get install -y cups cups-client hplip printer-driver-hpcups

# Enable CUPS service
systemctl enable cups
systemctl start cups

# Configure CUPS to accept remote connections (optional, for admin)
CUPSD_CONF="/etc/cups/cupsd.conf"
if [ ! -f "$CUPSD_CONF.orig" ]; then
  cp "$CUPSD_CONF" "$CUPSD_CONF.orig"
fi

# Allow connections from local network for administration
if ! grep -q "Listen 631" "$CUPSD_CONF"; then
  echo "Configuring CUPS for local network access..."
  sed -i 's/Listen localhost:631/Listen 631/' "$CUPSD_CONF" 2>/dev/null || true
  systemctl restart cups
fi

# --- Deploy custom PPD files ---
if [ -d "$MOD_TMP/ppd" ] && [ "$PPD_COUNT" -gt 0 ]; then
  echo ""
  echo "Installing $PPD_COUNT custom PPD file(s)..."
  
  PPD_DEST="/usr/share/cups/model"
  mkdir -p "$PPD_DEST"
  
  for ppd in "$MOD_TMP/ppd"/*.ppd; do
    [ -f "$ppd" ] || continue
    ppdname=$(basename "$ppd")
    echo "  $ppdname -> $PPD_DEST/"
    cp "$ppd" "$PPD_DEST/"
    chmod 644 "$PPD_DEST/$ppdname"
  done
fi

# --- Deploy custom filter scripts ---
if [ -d "$MOD_TMP/filters" ] && [ "$FILTER_COUNT" -gt 0 ]; then
  echo ""
  echo "Installing $FILTER_COUNT custom filter script(s)..."
  
  FILTER_DEST="/usr/local/bin"
  mkdir -p "$FILTER_DEST"
  
  for filt in "$MOD_TMP/filters"/*; do
    [ -f "$filt" ] || continue
    filtname=$(basename "$filt")
    echo "  $filtname -> $FILTER_DEST/"
    cp "$filt" "$FILTER_DEST/"
    chmod 755 "$FILTER_DEST/$filtname"
  done
fi

# --- Configure printers ---
if [ -z "$PRINTER_DEFS" ] || [ "$PRINTER_COUNT" = "0" ]; then
  echo ""
  echo "No printers to configure."
  echo "CUPS installed but no printers defined in yamc.local/cups/printers.conf"
  echo ""
  echo "===== CUPS Installation Complete ====="
  exit 0
fi

echo ""
echo "Configuring $PRINTER_COUNT printer(s)..."

# Decode printer definitions
DECODED=$(echo "$PRINTER_DEFS" | base64 -d)

# Process each printer
while IFS='|' read -r name uri desc driver opts; do
  [ -z "$name" ] && continue
  
  echo ""
  echo "Configuring printer: $name"
  echo "  URI: $uri"
  
  # Remove existing printer if present (for clean reconfiguration)
  if lpstat -p "$name" &>/dev/null; then
    echo "  Removing existing configuration..."
    lpadmin -x "$name" 2>/dev/null || true
  fi
  
  # Build lpadmin command
  CMD="lpadmin -p \"$name\" -E -v \"$uri\""
  
  # Add description if provided
  if [ -n "$desc" ]; then
    CMD="$CMD -D \"$desc\" -L \"$desc\""
  fi
  
  # Use specified driver or default to driverless (everywhere)
  if [ -n "$driver" ]; then
    echo "  Driver: $driver"
    # Check if it's a PPD file (ends with .ppd)
    if [[ "$driver" == *.ppd ]]; then
      # Use full path to PPD
      CMD="$CMD -P \"/usr/share/cups/model/$driver\""
    else
      # Use driver name as-is (for built-in drivers)
      CMD="$CMD -m \"$driver\""
    fi
  else
    echo "  Driver: everywhere (driverless IPP)"
    CMD="$CMD -m everywhere"
  fi
  
  # Add options if provided
  if [ -n "$opts" ]; then
    echo "  Options: $opts"
    CMD="$CMD -o $opts"
  fi
  
  # Execute
  echo "  Running: $CMD"
  if eval $CMD; then
    echo "  ✓ Printer $name configured"
    
    # Enable and accept jobs
    cupsenable "$name" 2>/dev/null || true
    cupsaccept "$name" 2>/dev/null || true
  else
    echo "  ✗ Failed to configure $name"
  fi
  
done <<< "$DECODED"

echo ""
echo "Configured printers:"
lpstat -p 2>/dev/null | grep -E "^printer" || echo "  (none)"

echo ""
echo "===== CUPS Configuration Complete ====="
echo ""
echo "Web admin: http://$(hostname):631"
echo "Print test: lp -d PrinterName /usr/share/cups/data/testprint"
