#!/bin/bash
# chrome/setup - Install Google Chrome on Ubuntu
#
# Usage: yamc -h hostname -u root chrome
#
# Adds Google's official apt repository and installs Chrome.
# Optionally installs a wrapper script for NFS environments.
# Idempotent - safe to run multiple times.

set -e

echo "===== Installing Google Chrome ====="

# Source environment from setup.loc
if [ -f "$MOD_TMP/env" ]; then
  . "$MOD_TMP/env"
fi

# Check architecture
ARCH=$(dpkg --print-architecture)
if [ "$ARCH" != "amd64" ]; then
  echo "ERROR: Google Chrome only supports amd64 architecture"
  echo "Current architecture: $ARCH"
  exit 1
fi

# Keyring location (modern approach, not deprecated apt-key)
KEYRING="/usr/share/keyrings/google-chrome.gpg"
REPO_FILE="/etc/apt/sources.list.d/google-chrome.list"

# Add Google's signing key if not present
if [ ! -f "$KEYRING" ]; then
  echo "Adding Google Chrome signing key..."
  wget -qO- https://dl.google.com/linux/linux_signing_key.pub | gpg --dearmor > "$KEYRING"
  echo "  ✓ Keyring added: $KEYRING"
else
  echo "  ✓ Keyring already present"
fi

# Add repository if not present
if [ ! -f "$REPO_FILE" ]; then
  echo "Adding Google Chrome repository..."
  echo "deb [arch=amd64 signed-by=$KEYRING] http://dl.google.com/linux/chrome/deb/ stable main" > "$REPO_FILE"
  echo "  ✓ Repository added: $REPO_FILE"
  
  # Update package index
  echo "Updating package index..."
  apt-get update -qq
else
  echo "  ✓ Repository already configured"
fi

# Install Chrome if not already installed
if dpkg -l google-chrome-stable 2>/dev/null | grep -q "^ii"; then
  echo "  ✓ Google Chrome already installed"
  
  # Show version
  CURRENT_VERSION=$(dpkg -l google-chrome-stable | grep "^ii" | awk '{print $3}')
  echo "  Version: $CURRENT_VERSION"
else
  echo "Installing Google Chrome..."
  apt-get install -y google-chrome-stable
  echo "  ✓ Google Chrome installed"
fi

# Install wrapper scripts if provided (for NFS home directories)
if [ -f "$MOD_TMP/google-chrome-wrapper" ]; then
  echo ""
  echo "Installing Chrome NFS-safe wrapper..."
  
  # Install main wrapper as google-chrome (intercepts all calls)
  MAIN_WRAPPER="/usr/local/bin/google-chrome"
  if [ -f "$MAIN_WRAPPER" ]; then
    if cmp -s "$MOD_TMP/google-chrome-wrapper" "$MAIN_WRAPPER"; then
      echo "  ✓ google-chrome wrapper already up to date"
    else
      cp "$MOD_TMP/google-chrome-wrapper" "$MAIN_WRAPPER"
      chmod 755 "$MAIN_WRAPPER"
      echo "  ✓ google-chrome wrapper updated: $MAIN_WRAPPER"
    fi
  else
    cp "$MOD_TMP/google-chrome-wrapper" "$MAIN_WRAPPER"
    chmod 755 "$MAIN_WRAPPER"
    echo "  ✓ google-chrome wrapper installed: $MAIN_WRAPPER"
  fi
  
  # Install convenience wrapper as chrome
  if [ -f "$MOD_TMP/chrome-wrapper" ]; then
    CHROME_WRAPPER="/usr/local/bin/chrome"
    if [ -f "$CHROME_WRAPPER" ]; then
      if cmp -s "$MOD_TMP/chrome-wrapper" "$CHROME_WRAPPER"; then
        echo "  ✓ chrome wrapper already up to date"
      else
        cp "$MOD_TMP/chrome-wrapper" "$CHROME_WRAPPER"
        chmod 755 "$CHROME_WRAPPER"
        echo "  ✓ chrome wrapper updated: $CHROME_WRAPPER"
      fi
    else
      cp "$MOD_TMP/chrome-wrapper" "$CHROME_WRAPPER"
      chmod 755 "$CHROME_WRAPPER"
      echo "  ✓ chrome wrapper installed: $CHROME_WRAPPER"
    fi
  fi
  
  echo ""
  echo "===== Google Chrome Installation Complete ====="
  echo ""
  echo "Launch Chrome with: chrome  or  google-chrome"
  echo "  (wrapper intercepts all calls, handles NFS home directory issues)"
  echo ""
  echo "Named profiles: chrome -p work"
  echo "                chrome --profile personal"
  echo ""
  echo "GUI launchers also use the wrapper automatically."
else
  echo ""
  echo "===== Google Chrome Installation Complete ====="
  echo ""
  echo "Chrome can be launched with: google-chrome"
  echo "Or from the application menu."
fi

