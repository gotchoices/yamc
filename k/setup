#!/bin/bash
# k/setup - Install K editor from GitHub
#
# This script clones the K editor from https://github.com/gotchoices/k.git,
# switches to the k46 branch, builds it, and installs it system-wide.
#
# Usage: yamc -h hostname -u root k

set -e  # Exit on any error

echo "===== Installing K Editor ====="

# Install required dependencies
if command -v apt-get &> /dev/null; then
  echo "Installing dependencies using apt..."
  apt-get update -q
  apt-get install -y git gcc make ncurses-dev
elif command -v dnf &> /dev/null; then
  echo "Installing dependencies using dnf..."
  dnf install -y git gcc make ncurses-devel
elif command -v yum &> /dev/null; then
  echo "Installing dependencies using yum..."
  yum install -y git gcc make ncurses-devel
else
  echo "WARNING: Unknown package manager. Make sure git, gcc, make and ncurses-dev are installed."
fi

# Always fetch and install the latest version
# This ensures we get updates but is still safe to run multiple times

# Use a temporary build directory
BUILD_DIR="/var/tmp/k-build"

# Check if repository is already cloned
if [ -d "$BUILD_DIR/k" ] && [ -d "$BUILD_DIR/k/.git" ]; then
  echo "Repository already exists. Updating to latest main branch..."
  cd "$BUILD_DIR/k"

  # Always fetch and pull latest changes from main
  echo "Fetching latest changes from GitHub..."
  git fetch origin main
  git pull origin main
else
  # Clean up any previous incomplete build
  if [ -d "$BUILD_DIR" ]; then
    echo "Cleaning previous build directory..."
    rm -rf "$BUILD_DIR"
  fi

  # Create build directory and clone
  echo "Creating build directory..."
  mkdir -p "$BUILD_DIR"
  cd "$BUILD_DIR"

  echo "Cloning K editor repository..."
  git clone https://github.com/gotchoices/k.git k
  cd k
fi

# Build and install using Makefile.k (handles configure automatically)
echo "Building K editor from k46 directory..."
cd "$BUILD_DIR/k/k46"

# Ensure configure has been run (generates joe/autoconf.h which is needed as config.h)
if [ ! -f Makefile ] || [ ! -f joe/autoconf.h ]; then
  echo "Running configure to generate build files..."
  ./configure
fi

# Create symlink from config.h to autoconf.h if needed
# (source code includes "config.h" but configure generates "autoconf.h")
if [ -f joe/autoconf.h ] && [ ! -f joe/config.h ]; then
  echo "Creating config.h symlink..."
  ln -s autoconf.h joe/config.h
fi

# Makefile.k handles configure automatically if needed, then builds
make -f Makefile.k

echo "Installing K editor..."
make -f Makefile.k install

# Install termcap file if needed
if [ ! -f /etc/termcap ] && [ -f "$MOD_DIR/termcap" ]; then
  echo "Installing termcap file..."
  install -m 644 "$MOD_DIR/termcap" /etc/
elif [ -f /etc/termcap ]; then
  echo "Termcap file already exists."
fi

# Test if k is correctly installed
if command -v k &> /dev/null; then
  echo "K editor is now installed and available."
else
  echo "WARNING: K editor installation complete, but 'k' command not found in PATH."
  echo "You may need to add /usr/local/bin to your PATH or restart your shell."
fi

echo "===== K Editor Installation Complete ====="
exit 0
