#!/bin/bash
# named/setup - Install and configure BIND DNS server
#
# This script installs BIND and deploys your authoritative DNS configuration.
# Targeted for Ubuntu/Debian systems.
#
# Usage: yamc -h hostname -u root named
# Resources required: named.conf, named.local, zones/

set -e  # Exit on any error

echo "===== Installing BIND DNS Server ====="

# Check if we're running as root
if [ "$(id -u)" -ne 0 ]; then
  echo "ERROR: This script must be run as root"
  exit 1
fi

# Validate resources directory
if [ -z "$RES_DIR" ] || [ ! -d "$RES_DIR" ]; then
  echo "ERROR: No resources directory specified or directory not found."
  echo "Usage: yamc -h hostname -u root -r /path/to/resources named"
  echo "Or create yamc.local/named/ with your DNS configuration."
  exit 1
fi

echo "Using resources from: $RES_DIR"

# Check for required files
if [ ! -f "$RES_DIR/named.conf" ]; then
  echo "ERROR: named.conf not found in resources directory"
  exit 1
fi

# Ubuntu/Debian paths
BIND_CONF_DIR="/etc/bind"
BIND_ZONE_DIR="/var/lib/bind"
BIND_SERVICE="named"  # Note: package is bind9, but service unit is named
BIND_USER="bind"
BIND_GROUP="bind"

# Install BIND if not present
if ! command -v named >/dev/null 2>&1; then
  echo "Installing BIND packages..."
  apt-get update -q
  apt-get install -y bind9 bind9utils bind9-doc dnsutils
fi

echo "BIND version: $(named -v)"

# Stop bind9 service before configuration
echo "Stopping $BIND_SERVICE service..."
systemctl stop "$BIND_SERVICE" 2>/dev/null || true

# Create directories if needed
mkdir -p "$BIND_CONF_DIR"
mkdir -p "$BIND_ZONE_DIR"
mkdir -p /var/log/named
chown $BIND_USER:$BIND_GROUP /var/log/named

# Backup existing configuration
if [ -f "$BIND_CONF_DIR/named.conf" ] && [ ! -f "$BIND_CONF_DIR/named.conf.orig" ]; then
  echo "Backing up original named.conf..."
  cp "$BIND_CONF_DIR/named.conf" "$BIND_CONF_DIR/named.conf.orig"
fi

# Deploy named.conf
echo "Deploying named.conf..."
cp "$RES_DIR/named.conf" "$BIND_CONF_DIR/named.conf"
chown root:$BIND_GROUP "$BIND_CONF_DIR/named.conf"
chmod 640 "$BIND_CONF_DIR/named.conf"

# Deploy named.local if it exists
if [ -f "$RES_DIR/named.local" ]; then
  echo "Deploying named.local..."
  cp "$RES_DIR/named.local" "$BIND_CONF_DIR/named.local"
  chown root:$BIND_GROUP "$BIND_CONF_DIR/named.local"
  chmod 640 "$BIND_CONF_DIR/named.local"
fi

# Deploy zone files
if [ -d "$RES_DIR/zones" ]; then
  echo "Deploying zone files..."
  
  # Copy all zone files
  for zonefile in "$RES_DIR/zones/"*; do
    if [ -f "$zonefile" ]; then
      filename=$(basename "$zonefile")
      echo "  Copying $filename..."
      cp "$zonefile" "$BIND_ZONE_DIR/$filename"
      chown $BIND_USER:$BIND_GROUP "$BIND_ZONE_DIR/$filename"
      chmod 640 "$BIND_ZONE_DIR/$filename"
    fi
  done
fi

# Verify configuration
echo "Verifying BIND configuration..."
if named-checkconf "$BIND_CONF_DIR/named.conf"; then
  echo "Configuration syntax OK"
else
  echo "ERROR: Configuration syntax check failed"
  exit 1
fi

# Check zone files if named.local defines them
if [ -f "$BIND_CONF_DIR/named.local" ]; then
  # Extract zone names and check them
  zones=$(grep -E '^\s*zone\s+"[^"]+"' "$BIND_CONF_DIR/named.local" | sed 's/.*zone "\([^"]*\)".*/\1/' || true)
  for zone in $zones; do
    zonefile="$BIND_ZONE_DIR/$zone"
    if [ -f "$zonefile" ]; then
      echo "Checking zone: $zone"
      named-checkzone "$zone" "$zonefile" || echo "WARNING: Zone check failed for $zone"
    fi
  done
fi

# Enable and start bind9 service
echo "Enabling $BIND_SERVICE service..."
systemctl enable "$BIND_SERVICE"

echo "Starting $BIND_SERVICE service..."
systemctl start "$BIND_SERVICE"

# Verify service is running
sleep 2
if systemctl is-active --quiet "$BIND_SERVICE"; then
  echo "$BIND_SERVICE service is running"
else
  echo "ERROR: $BIND_SERVICE service failed to start"
  systemctl status "$BIND_SERVICE"
  exit 1
fi

echo "===== BIND DNS Server Installation Complete ====="
echo ""
echo "Service status: $(systemctl is-active $BIND_SERVICE)"
echo "Configuration: $BIND_CONF_DIR/named.conf"
echo "Zone files: $BIND_ZONE_DIR/"
echo ""
echo "To edit configuration in the future, run:"
echo "  yamc -h $(hostname) -u root named edit"
echo ""
exit 0

